<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rocabella · Calendrier d'indisponibilités</title>
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --muted:#a6adbb; --text:#e7e9ee; --accent:#3b82f6;
    --blue:#3b82f6;   /* La Folie   */
    --red:#ef4444;    /* La Corniche*/
    --green:#10b981;  /* La Bastide */
    --purple:#a855f7; /* Le Cottage */
    --chip:#202636; --chip-b:#2b3346; --cell:#12151b; --cell-b:#222733;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;background:var(--bg);color:var(--text);line-height:1.45}
  .wrap{max-width:1200px;margin:0 auto;padding:24px 16px 42px}
  header h1{margin:0 0 6px}
  header p{margin:0;color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr;gap:18px;margin-top:20px}
  .card{background:var(--panel);border:1px solid #23293a;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  h2,h3{margin:0 0 10px;font-size:18px}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:8px 0 12px}
  .controls .spacer{flex:1}
  input[type="text"]{width:100%;max-width:560px;padding:8px 10px;border-radius:10px;border:1px solid #2c3448;background:#0e1118;color:var(--text)}
  button{background:#1f2534;color:var(--text);border:1px solid #2c3448;padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:700}
  button:hover{background:#232a3c}
  .btn-primary{background:var(--accent);border-color:var(--accent);color:#fff}
  .btn-danger{background:#2a1b1b;border-color:#522;color:#ffb4b4}
  .badge{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--chip-b);color:#c7cedd;border-radius:999px;padding:8px 14px;font-size:14px;font-weight:700}
  .filters,.legend{display:flex;flex-wrap:wrap;gap:10px}
  .filters label,.legend .item{display:flex;align-items:center;gap:8px;background:#111421;border:1px solid #22293b;padding:6px 9px;border-radius:999px}
  .dot{width:10px;height:10px;border-radius:50%}
  .blue{background:var(--blue)} .red{background:var(--red)} .green{background:var(--green)} .purple{background:var(--purple)}
  .msg{margin-top:8px;padding:10px 12px;border-radius:10px;font-weight:600;font-size:14px}
  .ok{background:#0f1a14;color:#9fefc0;border:1px solid #1d3e2f}
  .err{background:#241517;color:#ffb4b4;border:1px solid #4d2328}
  .loading{background:#1a1a2e;color:#a9b2ff;border:1px solid #2b2f4d}

  .cal-wrap{background:var(--panel);border:1px solid #23293a;border-radius:18px;padding:20px}
  .cal-toolbar{display:flex;align-items:center;gap:12px;margin:0 0 14px}
  .cal-toolbar .btn-round{width:44px;height:44px;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;font-size:18px}
  .cal-toolbar .title{margin-left:8px;margin-right:auto}
  .title .badge{font-size:16px;padding:10px 16px}

  .dow{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;padding:10px;border-radius:14px;background:#0f131c}
  .dow div{color:#9ca3af;font-weight:800;text-align:center;font-size:14px}

  .month-outer{background:#0f131c;border-radius:16px;padding:14px}
  .month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
  .cell{background:var(--cell);border:1px solid var(--cell-b);border-radius:14px;min-height:120px;padding:8px;display:flex;flex-direction:column;gap:8px}
  .cell.muted{opacity:.45}
  .daynum{font-size:14px;color:#a9b2c2;font-weight:800}
  .dots{display:flex;gap:8px;flex-wrap:wrap;margin-top:auto}
  .dots .dot{width:10px;height:10px;border-radius:50%;box-shadow:0 0 0 2px #0b0f17 inset}
  @media (max-width:650px){.cell{min-height:90px}}
  
  .year-wrap{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width:1100px){.year-wrap{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:820px){.year-wrap{grid-template-columns:repeat(2,1fr)}}
  @media (max-width:560px){.year-wrap{grid-template-columns:1fr}}
  .mini{background:#0e121b;border:1px solid #23293a;border-radius:14px;padding:8px}
  .mini h4{margin:0 0 6px;font-size:14px;color:#cdd3df}
  .mini .cell{min-height:42px;padding:4px}
  .mini .daynum{font-size:11px}
  .mini .dots .dot{width:8px;height:8px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Bienvenue sur le calendrier partagé des réservations de la Rocabella</h1>
    <p>Les points de couleur correspondent aux jours des réservations confirmées de chaque villa. Le calendrier est valable sur 2 ans à partir de la date du jour.</p>
  </header>

  <div class="grid">
    <!-- Section Source de données masquée, champs cachés pour fonctionnalités -->
    <input id="sourceUrl" type="hidden" value="https://resa.rocabella.fr/" />
    <input type="file" id="fileInput" accept=".json,application/json" style="display:none" />
    <div id="messageArea" style="display:none"></div>
    <span id="statusBadge" style="display:none"></span>

    <section class="card">
      <h2>Filtres et légende</h2>
      <div class="row" style="gap:16px">
        <div class="filters" id="filters">
          <label><input type="checkbox" data-prop="La Folie" checked /> La Folie</label>
          <label><input type="checkbox" data-prop="La Corniche" checked /> La Corniche</label>
          <label><input type="checkbox" data-prop="La Bastide" checked /> La Bastide</label>
          <label><input type="checkbox" data-prop="Le Cottage" checked /> Le Cottage</label>
        </div>
        <div class="legend">
          <span class="item"><span class="dot blue"></span> La Folie</span>
          <span class="item"><span class="dot red"></span> La Corniche</span>
          <span class="item"><span class="dot green"></span> La Bastide</span>
          <span class="item"><span class="dot purple"></span> Le Cottage</span>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Calendrier</h2>

      <div class="cal-toolbar">
        <button id="btnMonthly">Vue Mensuelle</button>
        <button id="btnYearly">Vue Annuelle</button>
        <span class="title"><span class="badge" id="periodLabel">—</span></span>
        <button id="btnPrev" class="btn-round">◀</button>
        <button id="btnNext" class="btn-round">▶</button>
      </div>

      <div class="cal-wrap">
        <div class="dow" aria-hidden="true">
          <div>Lun</div><div>Mar</div><div>Mer</div><div>Jeu</div><div>Ven</div><div>Sam</div><div>Dim</div>
        </div>
        <div class="month-outer">
          <div id="calendarArea" class="month-grid"></div>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
(function(){
  "use strict";

  const PROPS  = ["La Folie","La Corniche","La Bastide","Le Cottage"];
  const COLORS = {"La Folie":"blue","La Corniche":"red","La Bastide":"green","Le Cottage":"purple"};
  let viewMode = "month";
  let current  = new Date(); current.setHours(0,0,0,0);
  let dataMap  = new Map();
  let enabledProps = new Set(PROPS);
  let autoTimer = null;

  const $  = s => document.querySelector(s);
  const el = (t,c,txt)=>{const n=document.createElement(t); if(c)n.className=c; if(txt!=null)n.textContent=txt; return n;};
  const MONTHS = ["Janvier","Février","Mars","Avril","Mai","Juin","Juillet","Août","Septembre","Octobre","Novembre","Décembre"];

  const toKey     = d => `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,"0")}-${String(d.getUTCDate()).padStart(2,"0")}`;
  const fromISO   = iso => { const d = new Date(iso+"T00:00:00Z"); return Number.isNaN(d.getTime())?null:d; };
  const daysInMon = (y,m)=> new Date(Date.UTC(y,m+1,0)).getUTCDate();
  const startMon  = d => new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), 1));
  const addMonths = (d,n)=> new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth()+n, 1));
  const addYears  = (d,n)=> new Date(Date.UTC(d.getUTCFullYear()+n, d.getUTCMonth(), 1));
  const weekDay   = d => (new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate())).getUTCDay()+6)%7;

  function msg(type,text){
    const area=$("#messageArea"); area.innerHTML="";
    if(!text) return;
    area.appendChild(el("div","msg "+(type==="error"?"err":type==="loading"?"loading":"ok"),text));
  }
  
  function updateBadge(){
    const b=$("#statusBadge");
    if(dataMap.size===0){b.textContent="Aucune donnée";return;}
    const keys=[...dataMap.keys()].sort();
    const [y1,m1,d1]=keys[0].split("-"), [y2,m2,d2]=keys.at(-1).split("-");
    b.textContent=`Données: ${d1}/${m1}/${y1} → ${d2}/${m2}/${y2} (${dataMap.size} jours)`;
  }

  function loadData(json){
    dataMap.clear();
    const arr=Array.isArray(json)?json:[json];
    let count = 0;
    
    for(const obj of arr){
      if(!obj||typeof obj!=="object") continue;
      const d=fromISO(obj.date); if(!d) continue;
      const key=toKey(d);
      const entry={};
      for(const p of PROPS){
        const raw=(obj[p]??"Disponible").toString().trim().toLowerCase();
        entry[p]= raw==="indisponible" ? "Indisponible" : "Disponible";
      }
      dataMap.set(key,entry);
      count++;
    }
    
    console.log(`${count} jours chargés dans le calendrier`);
    updateBadge(); 
    render();
  }

  async function fetchAndParse(url){
    const res = await fetch(url,{headers:{'Accept':'application/json,text/plain;q=0.9,*/*;q=0.8'}});
    try{
      const j=await res.clone().json();
      if(j && (Array.isArray(j)||typeof j==="object")) return j;
    }catch(_){}
    const text=await res.text();
    try{
      const doc=new DOMParser().parseFromString(text,"text/html");
      const node=doc.querySelector('script[type="application/json"]');
      if(node && node.textContent){
        const j=JSON.parse(node.textContent);
        if(j && (Array.isArray(j)||typeof j==="object")) return j;
      }
    }catch(_){}
    const m=text.match(/\[\s*\{[\s\S]*?\}\s*\]/);
    if(m) return JSON.parse(m[0]);
    throw new Error("Impossible d'interpréter la réponse comme JSON.");
  }

  function render(){
    if(viewMode==="month") renderMonth(); else renderYear();
  }
  
  function renderMonth(){
    const area=$("#calendarArea"); area.innerHTML="";
    const y=current.getUTCFullYear(), m=current.getUTCMonth();
    $("#periodLabel").textContent = `${MONTHS[m]} ${y}`;

    const first = startMon(current);
    const firstDow = weekDay(first);
    const total = daysInMon(y,m);

    for(let i=0;i<firstDow;i++) area.appendChild(el("div","cell muted"));

    for(let day=1; day<=total; day++){
      const cell = el("div","cell");
      cell.appendChild(el("div","daynum", String(day)));

      const k = toKey(new Date(Date.UTC(y,m,day)));
      const entry = dataMap.get(k);
      const dots = el("div","dots");

      if(entry){
        const order=["La Folie","La Corniche","La Bastide","Le Cottage"];
        for(const p of order){
          if(!enabledProps.has(p)) continue;
          if(entry[p]==="Indisponible") dots.appendChild(el("span","dot "+COLORS[p]));
        }
      }
      cell.appendChild(dots);
      area.appendChild(cell);
    }

    const rem=(firstDow+total)%7; if(rem!==0){for(let i=rem;i<7;i++) area.appendChild(el("div","cell muted")); }
  }

  function renderYear(){
    const area=$("#calendarArea"); area.innerHTML="";
    const y=current.getUTCFullYear(); $("#periodLabel").textContent=`Année ${y}`;
    const wrap=document.createElement("div"); wrap.className="year-wrap";
    for(let m=0;m<12;m++){
      const sec=el("div","mini"); sec.appendChild(el("h4",null,`${MONTHS[m]} ${y}`));
      const grid=el("div","month-grid");
      const first=new Date(Date.UTC(y,m,1));
      const firstDow=weekDay(first);
      const total=daysInMon(y,m);

      for(let i=0;i<firstDow;i++) grid.appendChild(el("div","cell muted"));
      for(let d=1; d<=total; d++){
        const c=el("div","cell"); c.appendChild(el("div","daynum",String(d)));
        const k=toKey(new Date(Date.UTC(y,m,d))); const e=dataMap.get(k); const dots=el("div","dots");
        if(e){
          const order=["La Folie","La Corniche","La Bastide","Le Cottage"];
          for(const p of order){ if(enabledProps.has(p)&&e[p]==="Indisponible") dots.appendChild(el("span","dot "+COLORS[p])); }
        }
        c.appendChild(dots); grid.appendChild(c);
      }
      const rem=(firstDow+total)%7; if(rem!==0) for(let i=rem;i<7;i++) grid.appendChild(el("div","cell muted"));
      sec.appendChild(grid); wrap.appendChild(sec);
    }
    area.appendChild(wrap);
  }

  $("#btnMonthly").addEventListener("click",()=>{viewMode="month";render();});
  $("#btnYearly").addEventListener("click",()=>{viewMode="year";render();});
  $("#btnPrev").addEventListener("click",()=>{current=viewMode==="month"?addMonths(current,-1):addYears(current,-1);render();});
  $("#btnNext").addEventListener("click",()=>{current=viewMode==="month"?addMonths(current, 1):addYears(current, 1);render();});
  document.querySelectorAll('#filters input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener("change",()=>{const p=cb.getAttribute("data-prop"); if(cb.checked) enabledProps.add(p); else enabledProps.delete(p); render();});
  });

  async function fetchFromUrl(){
    const urlInput = document.querySelector("#sourceUrl");
    if(!urlInput) {
      console.error("Element #sourceUrl non trouvé");
      return;
    }
    
    const url = urlInput.value.trim(); 
    if(!url){
      console.error("URL vide");
      return;
    }
    
    console.log("Chargement des données depuis:", url);
    
    try{
      const payload=await fetchAndParse(url);
      if(Array.isArray(payload)||typeof payload==="object") {
        loadData(payload);
        console.log("✅ Données chargées avec succès");
      } else {
        throw new Error("Réponse inattendue.");
      }
    }catch(e){
      console.error("❌ Erreur de chargement:", e);
      if(e.message.includes("fetch") || e.name === "TypeError"){
        console.error("Erreur CORS détectée");
      }
    }
  }
  // Auto-refresh activé par défaut toutes les 6 heures
  autoTimer = setInterval(fetchFromUrl, 6*60*60*1000);

  $("#fileInput").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if(!file) return;
    
    msg("loading","Lecture du fichier...");
    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const json = JSON.parse(event.target.result);
        loadData(json);
      } catch(err) {
        msg("error","Fichier JSON invalide : " + err.message);
      }
    };
    reader.onerror = () => msg("error","Erreur lors de la lecture du fichier.");
    reader.readAsText(file);
  });

  // Chargement automatique au démarrage
  render(); 
  updateBadge();
  
  // S'assurer que le DOM est complètement chargé
  if(document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', fetchFromUrl);
  } else {
    fetchFromUrl(); // DOM déjà chargé, exécuter immédiatement
  }
  
  // Auto-refresh toutes les 6 heures
})();
</script>
</body>
</html>
