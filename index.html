<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendrier d’indisponibilités – Rocabella</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      padding: 0;
    }
    header {
      padding: 1em;
      text-align: center;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      gap: 1em;
      padding: 1em;
    }
    .panel {
      background: #1e1e1e;
      border-radius: 8px;
      padding: 1em;
      flex: 1;
      min-width: 300px;
    }
    textarea {
      width: 100%;
      min-height: 100px;
      background: #222;
      color: #eee;
      border: 1px solid #555;
    }
    button {
      margin: 0.2em;
      padding: 0.5em 1em;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #calendarArea {
      margin-top: 1em;
    }
    .legend span {
      display: inline-block;
      margin: 0.3em;
      padding: 0.3em 0.6em;
      border-radius: 4px;
    }
    .dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Calendrier d’indisponibilités – Rocabella</h1>
    <p>Source distante JSON, avec repli sur collage manuel si nécessaire.</p>
  </header>

  <div class="container">
    <div class="panel">
      <h3>1) Source de données</h3>
      <input id="jsonUrl" type="text" value="https://resa.rocabella.fr/" style="width:100%">
      <div>
        <button id="btnLoad">Charger depuis l’URL</button>
        <button id="btnAuto">Activer l’auto-refresh</button>
        <span id="statusBadge">Aucune donnée</span>
      </div>
      <h4>Collage manuel (secours)</h4>
      <textarea id="jsonInput" placeholder="Collez ici vos données JSON si l’URL n’est pas accessible…"></textarea>
      <div>
        <button id="btnApply">Appliquer le JSON collé</button>
        <button id="btnSample">Load Sample Data</button>
        <button id="btnClear">Effacer</button>
      </div>
      <h4>Filtres et légende</h4>
      <div id="filters">
        <label><input type="checkbox" data-prop="La Folie" checked><span class="dot" style="background:blue"></span>La Folie</label>
        <label><input type="checkbox" data-prop="La Corniche" checked><span class="dot" style="background:red"></span>La Corniche</label>
        <label><input type="checkbox" data-prop="La Bastide" checked><span class="dot" style="background:green"></span>La Bastide</label>
        <label><input type="checkbox" data-prop="Le Cottage" checked><span class="dot" style="background:purple"></span>Le Cottage</label>
      </div>
    </div>

    <div class="panel">
      <h3>2) Calendrier</h3>
      <div>
        <button id="btnMonth">Vue Mensuelle</button>
        <button id="btnYear">Vue Annuelle</button>
        <button id="btnPrev">&lt;</button>
        <button id="btnNext">&gt;</button>
      </div>
      <div id="calendarArea"></div>
    </div>
  </div>

  <script>
  // === VARIABLES ===
  const PROPS = ["La Folie","La Corniche","La Bastide","Le Cottage"];
  const COLORS = {
    "La Folie": "blue",
    "La Corniche": "red",
    "La Bastide": "green",
    "Le Cottage": "purple"
  };
  let dataMap = new Map();
  let enabledProps = new Set(PROPS);
  let viewMode = "month";
  let current = new Date();
  let autoTimer = null;

  // === UTILS ===
  function fromISO(s){ return new Date(s+"T00:00:00"); }
  function key(d){ return d.toISOString().slice(0,10); }
  function addMonths(d,n){ return new Date(d.getUTCFullYear(), d.getUTCMonth()+n, 1); }
  function addYears(d,n){ return new Date(d.getUTCFullYear()+n, d.getUTCMonth(), 1); }
  function daysInMonth(y,m){ return new Date(y,m+1,0).getDate(); }
  function weekDay(d){ return (new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()).getUTCDay()+6)%7; }
  const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];

  function msg(type,text){
    const area=document.querySelector("#statusBadge");
    area.textContent=text;
  }
  function updateBadge(){
    if(dataMap.size===0){ msg("info","Aucune donnée"); return; }
    msg("ok", dataMap.size+" jours chargés");
  }

  // === NORMALISATION DES DONNÉES ===
  function loadData(json){
    dataMap.clear();
    const arr = Array.isArray(json)? json:[json];
    for(const obj of arr){
      if(!obj || typeof obj!=="object") continue;
      const d=fromISO(obj.date); if(!d) continue;
      const entry={};
      for(const p of PROPS){
        const raw=(obj[p]||"Disponible").toString().trim().toLowerCase();
        entry[p]=(raw==="indisponible")?"Indisponible":"Disponible";
      }
      dataMap.set(key(d),entry);
    }
    updateBadge(); render();
  }

  // === EXTRACTION JSON (avec échappement <\/script>) ===
  async function fetchAndParse(url){
    const res=await fetch(url,{headers:{'Accept':'application/json,text/plain;q=0.9,*/*;q=0.8'}});
    try{
      const j=await res.clone().json();
      if(j && (Array.isArray(j)||typeof j==="object")) return j;
    }catch(_){}
    const text=await res.text();
    const doc=new DOMParser().parseFromString(text,"text/html");
    const node=doc.querySelector("script[type='application/json']");
    if(node && node.textContent){
      const j=JSON.parse(node.textContent);
      if(j && (Array.isArray(j)||typeof j==="object")) return j;
    }
    const m=text.match(/(\[\s*\{[\s\S]*?\}\s*\])/);
    if(m) return JSON.parse(m[0]);
    throw new Error("Impossible d’interpréter la réponse comme JSON.");
  }

  // === RENDU CALENDRIER ===
  function render(){
    const area=document.querySelector("#calendarArea");
    area.innerHTML="";
    if(viewMode==="month") renderMonth(); else renderYear();
  }
  function renderMonth(){
    const area=document.querySelector("#calendarArea");
    const y=current.getFullYear(), m=current.getMonth();
    const header=document.createElement("h3");
    header.textContent=MONTHS[m]+" "+y;
    area.appendChild(header);
    const grid=document.createElement("div");
    const total=daysInMonth(y,m);
    const start=new Date(y,m,1);
    const firstDow=weekDay(start);
    for(let i=0;i<firstDow;i++){ grid.appendChild(cell("")); }
    for(let d=1;d<=total;d++){
      const date=new Date(y,m,d);
      grid.appendChild(cell(d,date));
    }
    area.appendChild(grid);
  }
  function renderYear(){
    const area=document.querySelector("#calendarArea");
    const y=current.getFullYear();
    for(let m=0;m<12;m++){
      const sub=document.createElement("div");
      sub.innerHTML="<h4>"+MONTHS[m]+" "+y+"</h4>";
      const total=daysInMonth(y,m);
      for(let d=1;d<=total;d++){
        const date=new Date(y,m,d);
        const k=key(date);
        const e=dataMap.get(k)||{};
        const dots=[];
        for(const p of PROPS){
          if(enabledProps.has(p) && e[p]==="Indisponible"){
            dots.push("<span class='dot' style='background:"+COLORS[p]+"'></span>");
          }
        }
        if(dots.length>0){
          sub.innerHTML+=d+": "+dots.join("")+"<br>";
        }
      }
      area.appendChild(sub);
    }
  }
  function cell(label,date){
    const div=document.createElement("div");
    div.textContent=label;
    if(date){
      const k=key(date);
      const e=dataMap.get(k)||{};
      for(const p of PROPS){
        if(enabledProps.has(p) && e[p]==="Indisponible"){
          const dot=document.createElement("span");
          dot.className="dot";
          dot.style.background=COLORS[p];
          div.appendChild(dot);
        }
      }
    }
    return div;
  }

  // === EVENTS ===
  document.querySelector("#btnLoad").addEventListener("click",async()=>{
    try{
      const url=document.querySelector("#jsonUrl").value;
      const j=await fetchAndParse(url);
      loadData(j);
    }catch(e){msg("error",e.message);}
  });
  document.querySelector("#btnSample").addEventListener("click",()=>{
    const sample=[{"date":"2025-09-20","La Folie":"Disponible","La Corniche":"Indisponible","La Bastide":"Disponible","Le Cottage":"Disponible"}];
    loadData(sample);
  });
  document.querySelector("#btnApply").addEventListener("click",()=>{
    try{
      const raw=document.querySelector("#jsonInput").value;
      const j=JSON.parse(raw);
      loadData(j);
    }catch(e){msg("error","JSON invalide");}
  });
  document.querySelector("#btnClear").addEventListener("click",()=>{
    dataMap.clear();render();updateBadge();
  });
  document.querySelector("#btnMonth").addEventListener("click",()=>{viewMode="month";render();});
  document.querySelector("#btnYear").addEventListener("click",()=>{viewMode="year";render();});
  document.querySelector("#btnPrev").addEventListener("click",()=>{current=addMonths(current,-1);render();});
  document.querySelector("#btnNext").addEventListener("click",()=>{current=addMonths(current,1);render();});
  document.querySelectorAll("#filters input").forEach(cb=>{
    cb.addEventListener("change",()=>{
      if(cb.checked) enabledProps.add(cb.getAttribute("data-prop"));
      else enabledProps.delete(cb.getAttribute("data-prop"));
      render();
    });
  });
  </script>
</body>
</html>
